---
import { home, getExpectationsBackgroundTone, isExpectationsAnimationEnabled } from '../../../config/content';
import {
  normalizeBackgroundTone,
  normalizeBackgroundColor,
  sectionBackgroundClass,
  sectionBackgroundToneAttr,
  createBackgroundStyle,
} from '../../../utils/background';

type ExpectationsItem = {
  title?: string | null;
  description?: string | null;
  icon?: string | null;
};

const settings = home.expectations ?? {};
const props = (Astro.props ?? {}) as Record<string, any>;
const {
  backgroundTone: overrideTone,
  backgroundColor: overrideColor,
  backgroundClass: overrideClass,
  animation: animationOverride,
  eyebrow: eyebrowOverride,
  intro: introOverride,
  items: itemsOverride,
  ...restProps
} = props;

const fallbackTone = getExpectationsBackgroundTone();
const backgroundTone = normalizeBackgroundTone(overrideTone ?? settings.background?.tone ?? fallbackTone);
const backgroundClass = overrideClass ?? sectionBackgroundClass(backgroundTone);
const backgroundToneAttr = sectionBackgroundToneAttr(backgroundTone);
const backgroundColor = normalizeBackgroundColor(overrideColor ?? settings.background?.color);
const backgroundStyle = createBackgroundStyle(backgroundColor, backgroundTone);
const animationSetting = animationOverride ?? settings.animation;
const animationEnabled = animationSetting ?? isExpectationsAnimationEnabled();

const eyebrow = (eyebrowOverride ?? settings.eyebrow ?? undefined) as string | undefined;
const intro = (introOverride ?? settings.intro ?? undefined) as string | undefined;
const itemsSource = Array.isArray(itemsOverride) ? itemsOverride : settings.items;
const items = (Array.isArray(itemsSource) ? itemsSource : [])
  .map((item) => item as ExpectationsItem)
  .filter((item) => Boolean(item?.title?.trim() || item?.description?.trim()));

const hasContent = Boolean(eyebrow || intro || items.length > 0);
const shouldAnimate = animationEnabled !== false;
const sectionNumber = '05';
const sectionClasses = [backgroundClass, 'section-shell expectations-section'].filter(Boolean).join(' ');
const containerClasses = [
  'section-container space-y-10',
  shouldAnimate
    ? 'motion-safe:opacity-0 motion-safe:translate-y-6 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
    : '',
]
  .filter(Boolean)
  .join(' ');
const stackClasses = 'space-y-8';
const cardAnimationClasses = shouldAnimate
  ? 'motion-safe:opacity-0 motion-safe:translate-y-4 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
  : '';
---
{hasContent ? (
  <section
    class={sectionClasses}
    data-background-tone={backgroundToneAttr ?? undefined}
    style={backgroundStyle}
    data-expectations-root={shouldAnimate ? 'true' : undefined}
    {...restProps}
  >
    <div class={containerClasses} data-expectations-content>
      {(eyebrow || intro) && (
        <div class="space-y-4">
          {eyebrow ? (
            <div class="eyebrow-stack eyebrow-stack--inverse w-full text-left" data-align="left">
              <div class="eyebrow-banner-wrapper text-left">
                <p
                  class="eyebrow-banner eyebrow-banner--inverse"
                  data-align="left"
                  data-has-number={sectionNumber ? 'true' : undefined}
                >
                  <span class="eyebrow-banner__label">{eyebrow}</span>
                  {sectionNumber ? (
                    <span class="section-number-label text-white" aria-label={`Section ${sectionNumber}`}>
                      {sectionNumber}
                    </span>
                  ) : null}
                </p>
              </div>
            </div>
          ) : null}
          {intro && <p class="rich-intro text-left text-white/90">{intro}</p>}
        </div>
      )}
      {items.length > 0 ? (
        <div class={stackClasses}>
          {items.map(({ title, description }, index) => (
            <article
              class={['services-brief__card expectations-card w-full max-w-none text-left items-start gap-4', cardAnimationClasses]
                .filter(Boolean)
                .join(' ')}
              style={shouldAnimate ? `transition-delay: ${index * 120}ms;` : undefined}
              data-expectations-card
            >
              {title && <p class="rich-subheading text-white">{title}</p>}
              {description && <p class="rich-intro text-white/80">{description}</p>}
            </article>
          ))}
        </div>
      ) : null}
    </div>
    {shouldAnimate ? (
      <script>
        const roots = Array.from(document.querySelectorAll('[data-expectations-root="true"]'));
        const supportMatchMedia = typeof window !== 'undefined' && typeof window.matchMedia === 'function';
        const prefersReducedMotion = supportMatchMedia
          ? window.matchMedia('(prefers-reduced-motion: reduce)').matches
          : false;
        const reveal = (el: Element | null) => {
          if (el instanceof HTMLElement) {
            el.dataset.visible = 'true';
          }
        };

        roots.forEach((root) => {
          if (!(root instanceof HTMLElement)) return;
          if (root.dataset.expectationsAnimated === 'true') return;

          const content = root.querySelector('[data-expectations-content]');
          const cards = Array.from(root.querySelectorAll('[data-expectations-card]'));
          const targets = [content, ...cards];
          root.dataset.expectationsAnimated = 'true';

          if (prefersReducedMotion || !('IntersectionObserver' in window)) {
            targets.forEach((target) => reveal(target));
            return;
          }

          const observer = new IntersectionObserver(
            (entries, obs) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  reveal(entry.target);
                  obs.unobserve(entry.target);
                }
              });
            },
            {
              rootMargin: '0px 0px -10% 0px',
              threshold: 0.15,
            },
          );

          targets.forEach((target) => {
            if (target instanceof HTMLElement) {
              observer.observe(target);
            }
          });
        });
      </script>
    ) : null}
  </section>
) : null}
