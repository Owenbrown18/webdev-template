---
import type { SiteContent, TestimonialsContent } from '../../../types/content';
import {
  getTestimonialsVariant,
  getTestimonials,
  site,
  home,
  getTestimonialsBackgroundTone,
  isTestimonialsAnimationEnabled,
} from '../../../config/content';
import {
  normalizeBackgroundTone,
  normalizeBackgroundColor,
  sectionBackgroundClass,
  sectionBackgroundToneAttr,
  createBackgroundStyle,
} from '../../../utils/background';
import TestimonialsGrid from './TestimonialsGrid.astro';
import TestimonialsStack from './TestimonialsStack.astro';

const variants: Record<string, any> = {
  grid: TestimonialsGrid,
  stack: TestimonialsStack,
};

const variantKey = getTestimonialsVariant();
const providedQuotes = Astro.props.quotes as TestimonialsContent['items'] | undefined;
const quotes = Array.isArray(providedQuotes) ? providedQuotes : getTestimonials();
const currentSite = ((Astro.props.site as SiteContent) ?? site) as SiteContent;

const Component = variantKey === 'none' ? null : variants[variantKey] ?? variants.grid;
const safeQuotes = Array.isArray(quotes) ? quotes : [];
const settings = home.testimonials ?? {};
const title = settings.title ?? 'Kind Words';
const intro = settings.intro ?? `Real feedback from neighbors who trusted ${site.name}.`;
const eyebrow = settings.eyebrow ?? 'Testimonials';
const props = (Astro.props ?? {}) as Record<string, any>;
const {
  backgroundTone: overrideTone,
  backgroundColor: overrideColor,
  backgroundClass: overrideClass,
  animation: animationOverride,
  ...restProps
} = props;
const fallbackTone = getTestimonialsBackgroundTone();
const backgroundTone = normalizeBackgroundTone(overrideTone ?? settings.background?.tone ?? fallbackTone);
const backgroundClass = overrideClass ?? sectionBackgroundClass(backgroundTone);
const backgroundToneAttr = sectionBackgroundToneAttr(backgroundTone);
const backgroundColor = normalizeBackgroundColor(overrideColor ?? settings.background?.color);
const backgroundStyle = createBackgroundStyle(backgroundColor, backgroundTone);
const animationEnabled =
  animationOverride !== undefined ? animationOverride : isTestimonialsAnimationEnabled();
---
{Component && safeQuotes.length > 0 ? (
  <Component
    quotes={safeQuotes as TestimonialsContent['items']}
    site={currentSite}
    title={title}
    intro={intro}
    eyebrow={eyebrow}
    backgroundClass={backgroundClass}
    backgroundTone={backgroundToneAttr}
    backgroundStyle={backgroundStyle}
    animationEnabled={animationEnabled !== false}
    {...restProps}
  />
) : null}
