---
import type { SiteContent } from '../../../types/content';

interface Props {
  site: SiteContent;
  eyebrow?: string;
  title?: string;
  intro?: string;
  phoneLabel?: string | null;
  emailLabel?: string | null;
  backgroundClass?: string;
  backgroundTone?: string;
  backgroundStyle?: string;
  animationEnabled?: boolean;
}

const props = Astro.props as Props;
const {
  site,
  title = 'How can we help?',
  intro = 'Share a few project details and our team will reply within one business day.',
  eyebrow,
  phoneLabel,
  emailLabel,
  backgroundClass,
  backgroundTone,
  backgroundStyle,
  animationEnabled = true,
} = props;

const hours = Array.isArray(site.hours) ? site.hours : [];
const phoneDigits = site.phone ? site.phone.replace(/[^\d+]/g, '') : '';
const phoneHref = phoneDigits ? `tel:${phoneDigits}` : '';
const emailHref = site.email ? `mailto:${site.email}` : '';
const sectionClasses = [backgroundClass, 'section-shell'].filter(Boolean).join(' ');
const shouldAnimate = animationEnabled !== false;
const containerClasses = [
  'section-container space-y-10 sm:space-y-12',
  shouldAnimate
    ? 'motion-safe:opacity-0 motion-safe:translate-y-6 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:opacity-100 data-[visible=true]:motion-safe:translate-y-0'
    : '',
]
  .filter(Boolean)
  .join(' ');
const infoCardClasses = [
  'surface-card surface-card-static p-8 sm:p-12 mx-auto',
  shouldAnimate
    ? 'motion-safe:opacity-0 motion-safe:translate-y-6 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:opacity-100 data-[visible=true]:motion-safe:translate-y-0'
    : '',
]
  .filter(Boolean)
  .join(' ');
const hoursPanelClasses = 'mt-8 grid gap-6 rounded-2xl bg-slate-50 p-6 text-sm text-slate-700 sm:grid-cols-[minmax(0,1fr)_minmax(0,1fr)]';
const hasEyebrow = typeof eyebrow === 'string' && eyebrow.trim().length > 0;
const hasTitle = typeof title === 'string' && title.trim().length > 0;
const hasIntro = typeof intro === 'string' && intro.trim().length > 0;
---
<section
  class={sectionClasses}
  data-background-tone={backgroundTone ?? undefined}
  style={backgroundStyle}
  data-contact-info-root={shouldAnimate ? 'true' : undefined}
>
  <div class={containerClasses} data-contact-info-container>
    {(hasEyebrow || hasTitle || hasIntro) && (
      <div class="section-intro mx-auto max-w-3xl text-center" data-contact-info-card>
        {hasEyebrow && <p class="section-eyebrow">{eyebrow}</p>}
        {hasTitle && <h2 class="section-heading">{title}</h2>}
        {hasIntro && <p class="section-subtitle">{intro}</p>}
      </div>
    )}
    <article class={infoCardClasses} data-contact-info-card>
      {(site.phone || site.email) && (
        <div class="grid gap-4 text-sm text-slate-700 sm:grid-cols-2">
          {site.phone && (
            <div>
              <dt class="font-semibold text-slate-900">Phone</dt>
              <dd class="mt-1 text-base text-slate-700">
                <a href={phoneHref} class="text-brand-primary hover:underline">
                  {phoneLabel ?? site.phone}
                </a>
              </dd>
            </div>
          )}
          {site.email && (
            <div>
              <dt class="font-semibold text-slate-900">Email</dt>
              <dd class="mt-1 text-base text-slate-700">
                <a href={emailHref} class="text-brand-primary hover:underline">
                  {emailLabel ?? site.email}
                </a>
              </dd>
            </div>
          )}
        </div>
      )}
      {hours.length > 0 && (
        <div class={hoursPanelClasses}>
          <div class="space-y-2">
            {hours.map(({ label }) => (
              <div>{label}</div>
            ))}
          </div>
          <div class="space-y-2 text-right font-medium text-slate-900">
            {hours.map(({ open, close }) => (
              <div>
                {open}
                {close ? ` â€“ ${close}` : ''}
              </div>
            ))}
          </div>
        </div>
      )}
    </article>
  </div>
</section>

{shouldAnimate ? (
  <script>
    const roots = Array.from(document.querySelectorAll('[data-contact-info-root="true"]'));
    const supportMatchMedia = typeof window !== 'undefined' && typeof window.matchMedia === 'function';
    const prefersReducedMotion = supportMatchMedia
      ? window.matchMedia('(prefers-reduced-motion: reduce)').matches
      : false;
    const reveal = (el: Element | null) => {
      if (el instanceof HTMLElement) {
        el.dataset.visible = 'true';
      }
    };

    roots.forEach((root) => {
      if (!(root instanceof HTMLElement)) return;
      if (root.dataset.contactInfoAnimated === 'true') return;

      root.dataset.contactInfoAnimated = 'true';
      const targets = Array.from(root.querySelectorAll('[data-contact-info-card]'));

      if (targets.length === 0) return;

      if (prefersReducedMotion || !('IntersectionObserver' in window)) {
        targets.forEach((target) => reveal(target));
        return;
      }

      const observer = new IntersectionObserver(
        (entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              reveal(entry.target);
              obs.unobserve(entry.target);
            }
          });
        },
        {
          rootMargin: '0px 0px -10% 0px',
          threshold: 0.1,
        },
      );

      targets.forEach((target) => observer.observe(target));
    });
  </script>
) : null}
