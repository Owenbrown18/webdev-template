---
import type { SiteContent } from '../../../types/content';

interface Props {
  site: SiteContent;
  eyebrow?: string;
  title?: string;
  intro?: string;
  phoneLabel?: string | null;
  emailLabel?: string | null;
  backgroundClass?: string;
  backgroundTone?: string;
  backgroundStyle?: string;
  animationEnabled?: boolean;
}

const props = Astro.props as Props & Record<string, any>;
const {
  site,
  title = 'How can we help?',
  intro = 'Share a few project details and our team will reply within one business day.',
  eyebrow,
  phoneLabel,
  emailLabel,
  backgroundClass,
  backgroundTone,
  backgroundStyle,
  animationEnabled = true,
  ...restProps
} = props;

const hours = Array.isArray(site.hours) ? site.hours : [];
const phoneDigits = site.phone ? site.phone.replace(/[^\d+]/g, '') : '';
const phoneHref = phoneDigits ? `tel:${phoneDigits}` : '';
const emailHref = site.email ? `mailto:${site.email}` : '';
const sectionClasses = [backgroundClass ?? 'bg-surface-base', 'section-shell'].filter(Boolean).join(' ');
const shouldAnimate = animationEnabled !== false;
const introAnimationClasses = shouldAnimate
  ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
  : '';
const cardAnimationClasses = shouldAnimate
  ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[950ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
  : '';
const hasEyebrow = typeof eyebrow === 'string' && eyebrow.trim().length > 0;
const hasTitle = typeof title === 'string' && title.trim().length > 0;
const hasIntro = typeof intro === 'string' && intro.trim().length > 0;
---
<section
  class={sectionClasses}
  data-background-tone={backgroundTone ?? undefined}
  style={backgroundStyle}
  data-contact-info-root={shouldAnimate ? 'true' : undefined}
  {...restProps}
>
  <div class="section-container space-y-12" data-contact-info-container>
    {(hasEyebrow || hasTitle || hasIntro) && (
      <div class={`space-y-6 text-left ${introAnimationClasses}`} data-contact-info-card>
        {hasEyebrow && (
          <div class="eyebrow-stack w-full text-left" data-align="left">
            <div class="eyebrow-banner-wrapper text-left">
              <p class="eyebrow-banner" data-align="left">
                <span class="eyebrow-banner__label">{eyebrow}</span>
              </p>
            </div>
          </div>
        )}
        {hasTitle && <h2 class="section-heading mt-2 text-left">{title}</h2>}
        {hasIntro && <p class="rich-intro text-left text-slate-700">{intro}</p>}
      </div>
    )}
    <article
      class={`services-brief__card services-overview__card services-overview__card--featured card-aurora section-container space-y-8 p-6 sm:p-8 lg:p-10 text-white ${cardAnimationClasses}`}
      data-contact-info-card
    >
      {(site.phone || site.email) && (
        <div class="grid gap-6 text-left sm:grid-cols-2">
          {site.phone && (
            <div class="space-y-1">
              <dt class="text-sm font-semibold uppercase tracking-[0.25em] text-white/70">Phone</dt>
              <dd class="text-lg font-semibold">
                <a href={phoneHref} class="text-white transition hover:text-white/80">
                  {phoneLabel ?? site.phone}
                </a>
              </dd>
            </div>
          )}
          {site.email && (
            <div class="space-y-1">
              <dt class="text-sm font-semibold uppercase tracking-[0.25em] text-white/70">Email</dt>
              <dd class="text-lg font-semibold">
                <a href={emailHref} class="text-white transition hover:text-white/80">
                  {emailLabel ?? site.email}
                </a>
              </dd>
            </div>
          )}
        </div>
      )}
      {hours.length > 0 && (
        <div class="space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/70">Hours</h3>
          <div class="space-y-2 text-base text-white/90">
            {hours.map(({ label, open, close }) => (
              <div class="flex items-center justify-between gap-4 border-b border-white/20 pb-2 last:border-none">
                <span class="font-medium text-white">{label}</span>
                <span class="text-white/80">
                  {open}
                  {close ? ` â€“ ${close}` : ''}
                </span>
              </div>
            ))}
          </div>
        </div>
      )}
    </article>
  </div>
</section>

{shouldAnimate ? (
  <script>
    const roots = Array.from(document.querySelectorAll('[data-contact-info-root="true"]'));
    const supportMatchMedia = typeof window !== 'undefined' && typeof window.matchMedia === 'function';
    const prefersReducedMotion = supportMatchMedia
      ? window.matchMedia('(prefers-reduced-motion: reduce)').matches
      : false;
    const reveal = (el: Element | null) => {
      if (el instanceof HTMLElement) {
        el.dataset.visible = 'true';
      }
    };

    roots.forEach((root) => {
      if (!(root instanceof HTMLElement)) return;
      if (root.dataset.contactInfoAnimated === 'true') return;

      root.dataset.contactInfoAnimated = 'true';
      const targets = Array.from(root.querySelectorAll('[data-contact-info-card]'));

      if (targets.length === 0) return;

      if (prefersReducedMotion || !('IntersectionObserver' in window)) {
        targets.forEach((target) => reveal(target));
        return;
      }

      const observer = new IntersectionObserver(
        (entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              reveal(entry.target);
              obs.unobserve(entry.target);
            }
          });
        },
        {
          rootMargin: '0px 0px -10% 0px',
          threshold: 0.1,
        },
      );

      targets.forEach((target) => observer.observe(target));
    });
  </script>
) : null}
