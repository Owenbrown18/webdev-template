---
import ContactForm from '../info-form/ContactForm.astro';

interface HeroContent {
  tagLabel?: string | null;
  title?: string | null;
  subtitle?: string | null;
}

interface Props {
  hero?: HeroContent;
  backgroundClass?: string;
  backgroundTone?: string;
  backgroundStyle?: string;
  animationEnabled?: boolean;
}

const {
  hero: heroContent,
  backgroundClass,
  backgroundTone,
  backgroundStyle,
  animationEnabled = true,
}: Props = Astro.props as Props;

const heroData = heroContent ?? {};
const heroEyebrow = heroData.tagLabel?.trim() || heroData.title?.trim() || 'Contact';
const heroIntro = heroData.subtitle?.trim() || '';

const sectionClasses = [
  backgroundClass,
  'full-bleed section-overlay-dark relative isolate overflow-hidden text-white min-h-[calc(100vh-var(--header-height,5rem))]',
]
  .filter(Boolean)
  .join(' ');

const shouldAnimate = animationEnabled !== false;
const ancillaryAnimationClasses = shouldAnimate
  ? 'opacity-0 translate-y-4 transition duration-[900ms] ease-out data-[visible=true]:opacity-100 data-[visible=true]:translate-y-0'
  : '';
---
<section
  class={sectionClasses}
  data-background-tone={backgroundTone ?? undefined}
  style={backgroundStyle}
  data-hero-root
  data-animate={shouldAnimate ? 'true' : undefined}
>
  <div class="section-container flex h-full flex-col justify-center py-[clamp(3.5rem,12vh,6.5rem)]">
    <div class="flex flex-col gap-10 text-left lg:flex-row lg:items-start">
      <div class="flex w-full flex-col justify-between lg:flex-1 lg:max-w-3xl">
        <div class={`space-y-6 text-left ${ancillaryAnimationClasses}`} data-hero-ancillary>
          {heroEyebrow ? (
            <div class="eyebrow-stack eyebrow-stack--inverse w-full text-left" data-align="left">
              <div class="eyebrow-banner-wrapper text-left">
                <p class="eyebrow-banner eyebrow-banner--inverse services-hero-title" data-align="left">
                  <span class="eyebrow-banner__label">{heroEyebrow}</span>
                </p>
              </div>
            </div>
          ) : null}
          {heroIntro ? <p class="rich-intro rich-intro--inverse text-left max-w-2xl">{heroIntro}</p> : null}
        </div>
      </div>
      <div class="w-full lg:w-auto lg:flex-1 lg:max-w-xl">
        <div
          class={`contact-hero-card ${shouldAnimate ? 'opacity-0 translate-y-4 transition duration-[950ms] ease-out data-[visible=true]:opacity-100 data-[visible=true]:translate-y-0' : ''}`}
          data-hero-ancillary
        >
          <ContactForm id="contact-hero-form" variant="inverse" />
        </div>
      </div>
    </div>
  </div>
</section>

{shouldAnimate ? (
  <script>
    const init = () => {
      const root = document.querySelector('[data-hero-root][data-animate="true"]');
      if (!(root instanceof HTMLElement)) return;
      if (root.dataset.heroAnimated === 'true') return;
      root.dataset.heroAnimated = 'true';

      const prefersReducedMotion =
        typeof window !== 'undefined' &&
        typeof window.matchMedia === 'function' &&
        window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const ancillaryItems = Array.from(root.querySelectorAll('[data-hero-ancillary]'));

      const revealAncillary = () => {
        ancillaryItems.forEach((item, index) => {
          if (!(item instanceof HTMLElement)) return;
          const delay = prefersReducedMotion ? 0 : 250 + index * 120;
          window.setTimeout(() => {
            item.dataset.visible = 'true';
          }, delay);
        });
      };

      if (prefersReducedMotion || ancillaryItems.length === 0 || !('IntersectionObserver' in window)) {
        revealAncillary();
        return;
      }

      const observer = new IntersectionObserver(
        (entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              revealAncillary();
              obs.disconnect();
            }
          });
        },
        { threshold: 0.3 },
      );

      observer.observe(root);
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  </script>
) : null}
