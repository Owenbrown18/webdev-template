---
import {
  servicesPage,
  getServicesPageMetadata,
  getServicesHeroVariant,
  getServicesHeroBackgroundTone,
  isServicesHeroAnimationEnabled,
} from '../../../config/content';
import {
  normalizeBackgroundTone,
  normalizeBackgroundColor,
  sectionBackgroundClass,
  sectionBackgroundToneAttr,
  createBackgroundStyle,
} from '../../../utils/background';
import ServicesHeroShowcase from './ServicesHeroShowcase.astro';
import ServicesHeroFullscreen from './ServicesHeroFullscreen.astro';
import ServicesHeroObd from './ServicesHeroObd.astro';

const hero = servicesPage.hero ?? {};
const metadata = getServicesPageMetadata();
const rawProps = (Astro.props ?? {}) as Record<string, any>;
const variantValue = rawProps.variant;
const variantOverride =
  typeof variantValue === 'string' ? variantValue.trim().toLowerCase() : undefined;
const {
  backgroundTone: overrideTone,
  backgroundColor: overrideColor,
  backgroundClass: overrideClass,
  animation: animationOverride,
  ...restProps
} = rawProps;
delete restProps.variant;
delete restProps.backgroundTone;
delete restProps.backgroundColor;
delete restProps.backgroundClass;
delete restProps.animation;

const variants: Record<string, any> = {
  showcase: ServicesHeroShowcase,
  fullscreen: ServicesHeroFullscreen,
  serviceshero: ServicesHeroObd,
};

const variantKey = variantOverride ?? getServicesHeroVariant();
const fallbackTone = getServicesHeroBackgroundTone();
const normalizedTone = normalizeBackgroundTone(overrideTone ?? hero.background?.tone ?? fallbackTone);
const backgroundClass = overrideClass ?? sectionBackgroundClass(normalizedTone);
const backgroundToneAttr = sectionBackgroundToneAttr(normalizedTone);
const backgroundColor = normalizeBackgroundColor(overrideColor ?? hero.background?.color);
const backgroundStyle = createBackgroundStyle(backgroundColor, normalizedTone);
const animationSetting = animationOverride ?? hero.animation;
const animationEnabled = animationSetting ?? isServicesHeroAnimationEnabled();

const Component = variantKey === 'none' ? null : variants[variantKey] ?? variants.showcase;
const componentProps = {
  hero,
  metadata,
  backgroundClass,
  backgroundTone: backgroundToneAttr,
  backgroundStyle,
  animationEnabled: animationEnabled !== false,
  ...restProps,
};
const isFullscreenVariant = variantKey === 'fullscreen';
---
{Component ? (
  isFullscreenVariant ? (
    <div class="relative" data-services-hero>
      <Component {...componentProps} />
      <button
        type="button"
        class="fullscreen-hero__scroll-button"
        data-services-hero-scroll
        aria-label="Scroll down"
        data-visible="false"
      >
        <svg viewBox="0 0 20 20" fill="none" aria-hidden="true" class="h-5 w-5">
          <path
            d="M4.5 7.5L10 13l5.5-5.5"
            stroke="currentColor"
            stroke-width="1.8"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>
    </div>
  ) : (
    <Component {...componentProps} />
  )
) : null}

{isFullscreenVariant ? (
  <script>
    const init = () => {
      const root = document.querySelector('[data-services-hero]');
      const button = root?.querySelector('[data-services-hero-scroll]');
      if (!(button instanceof HTMLElement)) return;
      button.addEventListener('click', () => {
        const target = document.getElementById('services-scroll-target');
        if (!(target instanceof HTMLElement)) return;
        const rect = target.getBoundingClientRect();
        const offset = rect.top + window.scrollY;
        const adjust = offset - 32;
        window.scrollTo({ top: adjust, behavior: 'smooth' });
      });
      requestAnimationFrame(() => {
        button.dataset.visible = 'true';
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  </script>
) : null}
