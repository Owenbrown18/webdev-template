---
import { servicesPage, isServicesFaqAnimationEnabled } from '../../../config/content';

const base = servicesPage.faq ?? {};
const props = (Astro.props ?? {}) as Record<string, any>;
const {
  backgroundClass: overrideClass,
  animation: animationOverride,
  ...restProps
} = props;

const animationSetting = animationOverride ?? base.animation;
const animationEnabled = animationSetting ?? isServicesFaqAnimationEnabled();

const eyebrow = (restProps.eyebrow ?? base.eyebrow) as string | undefined;
const title = (restProps.title ?? base.title) as string | undefined;
const intro = (restProps.intro ?? base.intro) as string | undefined;
const items = Array.isArray(restProps.items ?? base.items)
  ? (restProps.items ?? base.items).filter((entry) => entry && (entry.question || entry.answer))
  : [];
const shouldRender = Boolean((eyebrow || title || intro) && items.length > 0);
const shouldAnimate = animationEnabled !== false;
const sectionNumber = '03';
const sectionClasses = [overrideClass ?? 'bg-surface-base', 'section-shell'].filter(Boolean).join(' ');
const introClasses = [
  'section-container space-y-4 text-left',
  shouldAnimate
    ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
    : '',
]
  .filter(Boolean)
  .join(' ');
const itemAnimationClass = shouldAnimate
  ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[800ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
  : '';
---
{shouldRender ? (
  <section
    id="services-faq"
    class={sectionClasses}
    data-faq-root={shouldAnimate ? 'true' : undefined}
  >
    <div class="section-container space-y-10">
      <div class={introClasses} data-faq-intro>
        {(eyebrow || title || sectionNumber) && (
          <div class="eyebrow-stack w-full text-left" data-align="left">
            <div class="eyebrow-banner-wrapper text-left">
              <p
                class="eyebrow-banner"
                data-align="left"
                data-has-number={sectionNumber ? 'true' : undefined}
              >
                <span class="eyebrow-banner__label">{eyebrow}</span>
                {sectionNumber ? (
                  <span class="section-number-label" aria-label={`Section ${sectionNumber}`}>
                    {sectionNumber}
                  </span>
                ) : null}
              </p>
            </div>
          </div>
        )}
        {title && <h2 class="section-heading mt-2 text-left">{title}</h2>}
        {intro && <p class="rich-intro text-left text-slate-700">{intro}</p>}
      </div>
      <dl class="space-y-6" data-faq-list>
        {items.map((item, index) => (
          <div
            class={`services-brief__card services-overview__card services-overview__card--featured card-aurora w-full text-left gap-3 p-6 sm:p-7 ${itemAnimationClass}`}
            data-faq-item
            data-index={index}
            style={shouldAnimate ? `transition-delay: ${index * 80}ms;` : undefined}
          >
            {item.question && <dt class="rich-subheading text-left text-white">{item.question}</dt>}
            {item.answer && <dd class="rich-intro rich-intro--inverse text-left">{item.answer}</dd>}
          </div>
        ))}
      </dl>
    </div>
    {shouldAnimate ? (
      <script>
        const roots = Array.from(document.querySelectorAll('[data-faq-root="true"]'));
        const supportMatchMedia = typeof window !== 'undefined' && typeof window.matchMedia === 'function';
        const prefersReducedMotion = supportMatchMedia
          ? window.matchMedia('(prefers-reduced-motion: reduce)').matches
          : false;

        const reveal = (el) => {
          if (el instanceof HTMLElement) {
            el.dataset.visible = 'true';
          }
        };

        roots.forEach((root) => {
          if (!(root instanceof HTMLElement)) {
            return;
          }

          if (root.dataset.faqAnimated === 'true') {
            return;
          }

          const intro = root.querySelector('[data-faq-intro]');
          const items = Array.from(root.querySelectorAll('[data-faq-item]'));
          const targets = [intro, ...items];

          if (targets.length === 0) {
            return;
          }

          root.dataset.faqAnimated = 'true';

          if (prefersReducedMotion || !('IntersectionObserver' in window)) {
            targets.forEach((target) => reveal(target));
            return;
          }

          const observer = new IntersectionObserver(
            (entries, obs) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  reveal(entry.target);
                  obs.unobserve(entry.target);
                }
              });
            },
            {
              rootMargin: '0px 0px -10% 0px',
              threshold: 0.1,
            },
          );

          targets.forEach((target) => {
            if (target instanceof HTMLElement) {
              observer.observe(target);
            }
          });
        });
      </script>
    ) : null}
  </section>
) : null}
