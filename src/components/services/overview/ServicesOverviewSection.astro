---
import {
  servicesPage,
  getServicesOverviewBackgroundTone,
  isServicesOverviewAnimationEnabled,
  getServices,
} from '../../../config/content';
import {
  normalizeBackgroundTone,
  normalizeBackgroundColor,
  sectionBackgroundClass,
  sectionBackgroundToneAttr,
  createBackgroundStyle,
} from '../../../utils/background';

const overview = servicesPage.overview ?? {};
const props = (Astro.props ?? {}) as Record<string, any>;
const {
  backgroundTone: overrideTone,
  backgroundClass: overrideClass,
  backgroundColor: overrideColor,
  animation: animationOverride,
  eyebrow: eyebrowOverride,
  intro: introOverride,
  ...restProps
} = props;

const fallbackTone = getServicesOverviewBackgroundTone();
const backgroundTone = normalizeBackgroundTone(overrideTone ?? overview.background?.tone ?? fallbackTone);
const backgroundClass = overrideClass ?? sectionBackgroundClass(backgroundTone);
const backgroundToneAttr = sectionBackgroundToneAttr(backgroundTone);
const backgroundColor = normalizeBackgroundColor(overrideColor ?? overview.background?.color);
const backgroundStyle = createBackgroundStyle(backgroundColor, backgroundTone);
const animationSetting = animationOverride ?? overview.animation;
const animationEnabled = animationSetting ?? isServicesOverviewAnimationEnabled();

const eyebrow = (eyebrowOverride ?? overview.eyebrow) as string | undefined;
const intro = (introOverride ?? overview.intro) as string | undefined;
const sectionProps = { ...restProps };
delete sectionProps.eyebrow;
delete sectionProps.intro;
const sectionNumber = '01';
const hasContent = Boolean(eyebrow || intro);
const services = getServices().filter(Boolean);
const shouldAnimate = animationEnabled !== false;
const cardClasses = [
  'section-shell',
  backgroundClass,
]
  .filter(Boolean)
  .join(' ');
const contentClasses = 'section-container space-y-8 text-left';
const introAnimationClass = shouldAnimate
  ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
  : '';
const cardAnimationClass = shouldAnimate
  ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
  : '';
const accordionBaseClasses =
  'services-accordion services-brief__card services-overview__card services-overview__card--featured card-aurora text-left overflow-hidden';
const accordionHeaderClasses =
  'flex w-full items-start justify-between gap-4 px-5 py-4 text-left text-white';
const accordionPanelClasses =
  'space-y-4 border-t border-white/15 bg-transparent px-5 pb-5 pt-4 text-white';
const featureListClasses = 'flex flex-wrap gap-2';
const featureChipClasses =
  'rounded-full bg-white/10 px-3 py-1 text-sm font-medium text-white shadow-[inset_0_1px_0_rgba(255,255,255,0.2)] border border-white/20';
const metaLineClasses =
  'flex items-center gap-2 rich-intro rich-intro--inverse text-left text-white/90';
---
{hasContent ? (
  <section
    class={cardClasses}
    data-background-tone={backgroundToneAttr ?? undefined}
    style={backgroundStyle}
    data-overview-root={shouldAnimate ? 'true' : undefined}
    {...sectionProps}
  >
    <div class={contentClasses} data-overview-content>
      {(eyebrow || intro) && (
        <div class={`space-y-4 text-left ${introAnimationClass}`} data-overview-intro>
          {eyebrow ? (
            <div class="eyebrow-stack w-full text-left" data-align="left">
              <div class="eyebrow-banner-wrapper text-left">
                <p
                  class="eyebrow-banner"
                  data-align="left"
                  data-has-number={sectionNumber ? 'true' : undefined}
                >
                  <span class="eyebrow-banner__label">{eyebrow}</span>
                  {sectionNumber ? (
                    <span class="section-number-label" aria-label={`Section ${sectionNumber}`}>
                      {sectionNumber}
                    </span>
                  ) : null}
                </p>
              </div>
            </div>
          ) : null}
          {intro ? <p class="rich-intro text-left">{intro}</p> : null}
        </div>
      )}
      <div class="space-y-4">
        {services.map((service, index) => {
          const features = Array.isArray(service?.features) ? service.features.filter(Boolean) : [];
          const summaryParagraphs = typeof service?.summary === 'string'
            ? service.summary
                .split(/\n\s*\n/)
                .map((paragraph) => paragraph.trim())
                .filter(Boolean)
            : [];
          const sectionSubNumber = `01.${index + 1}`;
          const serviceAnchor = service.slug ? `services-card-${service.slug}` : `services-card-${index}`;
          const panelId = `${serviceAnchor}-panel`;
          return (
            <article
              class={`${accordionBaseClasses} ${cardAnimationClass}`.trim()}
              key={service.slug ?? index}
              id={serviceAnchor}
              data-overview-card
              style={shouldAnimate ? `transition-delay: ${index * 120}ms;` : undefined}
            >
              <button
                type="button"
                class={accordionHeaderClasses}
                data-accordion-trigger
                aria-expanded="false"
                aria-controls={panelId}
              >
                <div class="flex flex-col gap-2 text-left text-white">
                  <div class="services-overview__eyebrow services-subheading" data-has-number="true">
                    <span>{service.title}</span>
                    <span class="section-number-label text-white" aria-label={`Section ${sectionSubNumber}`}>
                      {sectionSubNumber}
                    </span>
                  </div>
                  <div class="flex flex-wrap gap-3 text-sm font-semibold text-white/85">
                    {service.duration ? <span class="rich-intro rich-intro--inverse text-white/90">Timeline: {service.duration}</span> : null}
                    {service.startingPrice ? (
                      <span class="inline-flex items-center gap-2 rich-intro rich-intro--inverse text-white/90">
                        <span class="h-1 w-1 rounded-full bg-white/50" aria-hidden="true"></span>
                        <span>Starting at: {service.startingPrice}</span>
                      </span>
                    ) : null}
                  </div>
                </div>
                <svg
                  class="h-5 w-5 shrink-0 text-white/80 transition-transform duration-300"
                  viewBox="0 0 20 20"
                  fill="none"
                  aria-hidden="true"
                  data-accordion-icon
                >
                  <path
                    d="M6 8l4 4 4-4"
                    stroke="currentColor"
                    stroke-width="1.6"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <div
                id={panelId}
                data-accordion-panel
                class={accordionPanelClasses}
                hidden
              >
                {summaryParagraphs.length > 0 ? (
                  <div class="space-y-3 text-white">
                    {summaryParagraphs.map((paragraph) => (
                      <p class="rich-intro rich-intro--inverse text-left text-white/95">{paragraph}</p>
                    ))}
                  </div>
                ) : null}
                {features.length > 0 ? (
                  <div class="space-y-2">
                    <p class="text-sm font-semibold uppercase tracking-[0.12em] text-white/70">Included</p>
                    <ul class={featureListClasses}>
                      {features.map((feature) => (
                        <li class={featureChipClasses}>{feature}</li>
                      ))}
                    </ul>
                  </div>
                ) : null}
                {(service.duration || service.startingPrice) && summaryParagraphs.length === 0 ? (
                  <div class="space-y-2">
                    {service.duration ? (
                      <p class={metaLineClasses}>
                        <span class="inline-flex h-2 w-2 rounded-full bg-emerald-400/80" aria-hidden="true"></span>
                        <span>Timeline: {service.duration}</span>
                      </p>
                    ) : null}
                    {service.startingPrice ? (
                      <p class={metaLineClasses}>
                        <span class="inline-flex h-2 w-2 rounded-full bg-sky-400/80" aria-hidden="true"></span>
                        <span>Starting at: {service.startingPrice}</span>
                      </p>
                    ) : null}
                  </div>
                ) : null}
              </div>
            </article>
          );
        })}
      </div>
    </div>
    {shouldAnimate ? (
      <script>
        const roots = Array.from(document.querySelectorAll('[data-overview-root="true"]'));
        const supportMatchMedia = typeof window !== 'undefined' && typeof window.matchMedia === 'function';
        const prefersReducedMotion = supportMatchMedia
          ? window.matchMedia('(prefers-reduced-motion: reduce)').matches
          : false;

        const reveal = (el) => {
          if (el instanceof HTMLElement) {
            el.dataset.visible = 'true';
          }
        };

        roots.forEach((root) => {
          if (!(root instanceof HTMLElement)) {
            return;
          }

          if (root.dataset.overviewAnimated === 'true') {
            return;
          }

          if (root.dataset.overviewAccordion === 'true') {
            return;
          }

          const content = root.querySelector('[data-overview-intro]');
          const cards = Array.from(root.querySelectorAll('[data-overview-card]'));
          const targets = [content, ...cards];
          if (!targets.length) {
            return;
          }

          root.dataset.overviewAnimated = 'true';
          root.dataset.overviewAccordion = 'true';

          const triggers = Array.from(root.querySelectorAll('[data-accordion-trigger]')).filter(
            (el) => el instanceof HTMLButtonElement,
          );

          triggers.forEach((trigger) => {
            const button = trigger as HTMLButtonElement;
            const panelId = button.getAttribute('aria-controls');
            const panel = typeof panelId === 'string' ? document.getElementById(panelId) : null;
            const icon = button.querySelector('[data-accordion-icon]');

            const setExpanded = (expanded: boolean) => {
              button.setAttribute('aria-expanded', expanded ? 'true' : 'false');
              if (panel instanceof HTMLElement) {
                panel.hidden = !expanded;
              }
              if (icon instanceof HTMLElement) {
                icon.classList.toggle('rotate-180', expanded);
              }
            };

            setExpanded(false);

            button.addEventListener('click', () => {
              const expanded = button.getAttribute('aria-expanded') === 'true';
              setExpanded(!expanded);
            });
          });

          if (prefersReducedMotion || !('IntersectionObserver' in window)) {
            targets.forEach((target) => target && reveal(target));
            return;
          }

          const observer = new IntersectionObserver(
            (entries, obs) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  reveal(entry.target);
                  obs.unobserve(entry.target);
                }
              });
            },
            {
              rootMargin: '0px 0px -10% 0px',
              threshold: 0.2,
            },
          );

          targets.forEach((target) => target && observer.observe(target));
        });
      </script>
    ) : null}
  </section>
) : null}
