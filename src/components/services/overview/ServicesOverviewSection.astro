---
import {
  servicesPage,
  getServicesOverviewBackgroundTone,
  isServicesOverviewAnimationEnabled,
  getServices,
} from '../../../config/content';
import {
  normalizeBackgroundTone,
  normalizeBackgroundColor,
  sectionBackgroundClass,
  sectionBackgroundToneAttr,
  createBackgroundStyle,
} from '../../../utils/background';

const overview = servicesPage.overview ?? {};
const props = (Astro.props ?? {}) as Record<string, any>;
const {
  backgroundTone: overrideTone,
  backgroundClass: overrideClass,
  backgroundColor: overrideColor,
  animation: animationOverride,
  eyebrow: eyebrowOverride,
  intro: introOverride,
  ...restProps
} = props;

const fallbackTone = getServicesOverviewBackgroundTone();
const backgroundTone = normalizeBackgroundTone(overrideTone ?? overview.background?.tone ?? fallbackTone);
const backgroundClass = overrideClass ?? sectionBackgroundClass(backgroundTone);
const backgroundToneAttr = sectionBackgroundToneAttr(backgroundTone);
const backgroundColor = normalizeBackgroundColor(overrideColor ?? overview.background?.color);
const backgroundStyle = createBackgroundStyle(backgroundColor, backgroundTone);
const animationSetting = animationOverride ?? overview.animation;
const animationEnabled = animationSetting ?? isServicesOverviewAnimationEnabled();

const eyebrow = (eyebrowOverride ?? overview.eyebrow) as string | undefined;
const intro = (introOverride ?? overview.intro) as string | undefined;
const sectionProps = { ...restProps };
delete sectionProps.eyebrow;
delete sectionProps.intro;
const sectionNumber = '01';
const hasContent = Boolean(eyebrow || intro);
const services = getServices();
const featuredService = services[0];
const featuredSummary = typeof featuredService?.summary === 'string'
  ? featuredService.summary
      .split(/\n\s*\n/)
      .map((paragraph) => paragraph.trim())
      .filter(Boolean)
  : [];
const featuredFeatures = Array.isArray(featuredService?.features)
  ? featuredService.features.filter(Boolean)
  : [];
const shouldAnimate = animationEnabled !== false;
const cardClasses = [
  'section-shell',
  backgroundClass,
]
  .filter(Boolean)
  .join(' ');
const contentClasses = [
  'section-container space-y-8 text-left',
  shouldAnimate
    ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
    : '',
]
  .filter(Boolean)
  .join(' ');
---
{hasContent ? (
  <section
    class={cardClasses}
    data-background-tone={backgroundToneAttr ?? undefined}
    style={backgroundStyle}
    data-overview-root={shouldAnimate ? 'true' : undefined}
    {...sectionProps}
  >
    <div class={contentClasses} data-overview-content>
      {(eyebrow || intro) && (
        <div class="space-y-4 text-left">
          {eyebrow ? (
            <div class="eyebrow-stack w-full text-left" data-align="left">
              <div class="eyebrow-banner-wrapper text-left">
                <p
                  class="eyebrow-banner"
                  data-align="left"
                  data-has-number={sectionNumber ? 'true' : undefined}
                >
                  <span class="eyebrow-banner__label">{eyebrow}</span>
                  {sectionNumber ? (
                    <span class="section-number-label" aria-label={`Section ${sectionNumber}`}>
                      {sectionNumber}
                    </span>
                  ) : null}
                </p>
              </div>
            </div>
          ) : null}
          {intro ? <p class="rich-intro text-left">{intro}</p> : null}
        </div>
      )}
      {featuredService ? (
        <article class="services-brief__card services-overview__card services-overview__card--featured">
          <div class="space-y-5 text-left">
            <div class="services-overview__eyebrow hero-toc__label">
              <span class="flex items-center gap-3">
                {featuredService.icon ? <span aria-hidden="true">{featuredService.icon}</span> : null}
                <span>{featuredService.title}</span>
              </span>
            </div>
            {featuredSummary.length > 0 ? (
              <div class="space-y-4 text-left">
                {featuredSummary.map((paragraph) => (
                  <p class="rich-intro rich-intro--inverse text-left">{paragraph}</p>
                ))}
              </div>
            ) : null}
            <div class="services-overview__meta">
              {featuredService.duration ? (
                <p class="hero-toc__label services-overview__meta-line">
                  <span>Timeline</span>
                  <span class="services-overview__meta-value">{featuredService.duration}</span>
                </p>
              ) : null}
              {featuredService.startingPrice ? (
                <p class="hero-toc__label services-overview__meta-line">
                  <span>Starting at</span>
                  <span class="services-overview__meta-value">{featuredService.startingPrice}</span>
                </p>
              ) : null}
            </div>
          </div>
          {featuredFeatures.length > 0 ? (
            <ul class="services-overview__feature-list">
              {featuredFeatures.map((feature) => (
                <li class="rich-intro rich-intro--inverse">{feature}</li>
              ))}
            </ul>
          ) : null}
        </article>
      ) : null}
    </div>
    {shouldAnimate ? (
      <script>
        const roots = Array.from(document.querySelectorAll('[data-overview-root="true"]'));
        const supportMatchMedia = typeof window !== 'undefined' && typeof window.matchMedia === 'function';
        const prefersReducedMotion = supportMatchMedia
          ? window.matchMedia('(prefers-reduced-motion: reduce)').matches
          : false;

        const reveal = (el) => {
          if (el instanceof HTMLElement) {
            el.dataset.visible = 'true';
          }
        };

        roots.forEach((root) => {
          if (!(root instanceof HTMLElement)) {
            return;
          }

          if (root.dataset.overviewAnimated === 'true') {
            return;
          }

          const content = root.querySelector('[data-overview-content]');
          if (!(content instanceof HTMLElement)) {
            return;
          }

          root.dataset.overviewAnimated = 'true';

          if (prefersReducedMotion || !('IntersectionObserver' in window)) {
            reveal(content);
            return;
          }

          const observer = new IntersectionObserver(
            (entries, obs) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  reveal(entry.target);
                  obs.unobserve(entry.target);
                }
              });
            },
            {
              rootMargin: '0px 0px -10% 0px',
              threshold: 0.2,
            },
          );

          observer.observe(content);
        });
      </script>
    ) : null}
  </section>
) : null}
