---
interface Profile {
  name?: string;
  role?: string;
  bio?: string;
  story?: string;
  image?: string;
  highlight?: string;
}

interface FormattedProfile extends Profile {
  paragraphs: string[];
}

interface Props {
  title: string;
  intro?: string;
  eyebrow?: string;
  supporting?: string;
  profiles: Profile[];
  backgroundClass?: string;
  backgroundTone?: string;
  backgroundStyle?: string;
  animationEnabled?: boolean;
}

const {
  title,
  intro,
  eyebrow,
  supporting,
  profiles,
  backgroundClass,
  backgroundTone,
  backgroundStyle,
  animationEnabled = true,
}: Props = Astro.props as Props;

const formattedProfiles: FormattedProfile[] = profiles.map((profile) => ({
  ...profile,
  paragraphs:
    typeof profile.story === 'string'
      ? profile.story
          .split(/\n{2,}/)
          .map((block) => block.trim())
          .filter(Boolean)
      : [],
}));
const sectionClasses = [backgroundClass, 'section-shell'].filter(Boolean).join(' ');
const shouldAnimate = animationEnabled !== false;
const cardAnimationClasses = shouldAnimate
  ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[1000ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
  : '';
---
<section
  class={sectionClasses}
  data-background-tone={backgroundTone ?? undefined}
  style={backgroundStyle}
  data-founders-root={shouldAnimate ? '' : undefined}
  id="founders"
>
  <div class="section-container">
    <div class="section-intro max-w-3xl">
      {eyebrow && <p class="section-eyebrow">{eyebrow}</p>}
      <h2 class="section-heading">{title}</h2>
      {intro && <p class="section-subtitle leading-7 text-slate-700">{intro}</p>}
      {supporting && (
        <p class="mt-6 mx-auto max-w-2xl text-base leading-7 text-slate-600 text-center">
          {supporting}
        </p>
      )}
    </div>
    <div class="mt-12 space-y-12">
      {formattedProfiles.map(
        ({ name, role, bio, image, highlight, paragraphs }, index) => (
          <article
            class={`surface-card grid gap-8 p-6 transition-shadow duration-200 hover:shadow-card-hover lg:grid-cols-[minmax(0,230px),1fr] ${cardAnimationClasses}`}
            data-founders-card={shouldAnimate ? '' : undefined}
            style={shouldAnimate ? `transition-delay: ${120 + index * 80}ms;` : undefined}
          >
            <div class="relative">
              <div class="aspect-[4/5] w-full overflow-hidden rounded-2xl bg-slate-100 shadow-inner">
                {image ? (
                  <img
                    src={image}
                    alt={name ? `${name} portrait` : ''}
                    class="h-full w-full object-cover object-center"
                    loading="lazy"
                    decoding="async"
                  />
                ) : (
                  <div class="flex h-full w-full items-center justify-center bg-gradient-to-br from-slate-200 via-white to-slate-100 text-3xl font-semibold text-slate-400">
                    {name
                      ?.split(' ')
                      .map((part) => part[0])
                      .filter(Boolean)
                      .slice(0, 2)
                      .join('') ?? 'FG'}
                  </div>
                )}
              </div>
              {highlight && (
                <span class="absolute bottom-4 left-4 inline-flex rounded-full bg-brand-primary/90 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-white">
                  {highlight}
                </span>
              )}
            </div>
            <div class="space-y-4">
              <div>
                <h3 class="text-xl font-semibold text-slate-900">{name}</h3>
                {role && <p class="text-sm font-medium uppercase tracking-wide text-brand-primary/80">{role}</p>}
              </div>
              {bio && <p class="text-base leading-7 text-slate-700">{bio}</p>}
              {paragraphs.length > 0 && (
                <div class="space-y-4 text-base leading-7 text-slate-600">
                  {paragraphs.map((paragraph) => (
                    <p>{paragraph}</p>
                  ))}
                </div>
              )}
            </div>
          </article>
        ),
      )}
    </div>
  </div>
  {shouldAnimate ? (
    <script>
      const roots = Array.from(document.querySelectorAll('[data-founders-root]'));
      const supportMatchMedia = typeof window !== 'undefined' && typeof window.matchMedia === 'function';
      const prefersReducedMotion = supportMatchMedia
        ? window.matchMedia('(prefers-reduced-motion: reduce)').matches
        : false;
      const reveal = (el) => {
        if (el instanceof HTMLElement) {
          el.dataset.visible = 'true';
        }
      };

      roots.forEach((root) => {
        const cards = Array.from(root.querySelectorAll('[data-founders-card]'));
        if (cards.length === 0) return;

        if (!prefersReducedMotion && 'IntersectionObserver' in window) {
          const observer = new IntersectionObserver(
            (entries, obs) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  reveal(entry.target);
                  obs.unobserve(entry.target);
                }
              });
            },
            {
              rootMargin: '0px 0px -10% 0px',
              threshold: 0.12,
            },
          );

          cards.forEach((card) => observer.observe(card));
        } else {
          cards.forEach((card) => reveal(card));
        }
      });
    </script>
  ) : null}
</section>
