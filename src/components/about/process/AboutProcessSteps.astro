---
interface StepItem {
  title?: string;
  description?: string;
}

interface Props {
  title?: string;
  intro?: string;
  eyebrow?: string;
  steps: StepItem[];
  id?: string;
  backgroundClass?: string;
  animationEnabled?: boolean;
  backgroundTone?: string;
  backgroundStyle?: string;
}

const {
  title,
  intro,
  eyebrow,
  steps,
  id,
  backgroundClass,
  animationEnabled = true,
  backgroundTone,
  backgroundStyle,
}: Props = Astro.props as Props;

const sectionClasses = [backgroundClass, 'section-shell section-overlay-dark'].filter(Boolean).join(' ');
const sectionNumber = '02';
const shouldAnimate = animationEnabled !== false;
const introAnimationClasses = shouldAnimate
  ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[900ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
  : '';
const cardAnimationClasses = shouldAnimate
  ? 'motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-[1400ms] motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100'
  : '';
const cardClasses = [
  'services-brief__card expectations-card w-full text-left items-start gap-4 p-6',
  cardAnimationClasses,
]
  .filter(Boolean)
  .join(' ');
---
<section
  id={id ?? undefined}
  class={sectionClasses}
  data-background-tone={backgroundTone ?? undefined}
  style={backgroundStyle}
  data-process-root
>
  <div class="section-container space-y-10">
    {(eyebrow || intro) && (
      <div class={`space-y-4 text-left ${introAnimationClasses}`} data-process-intro>
        {eyebrow ? (
          <div class="eyebrow-stack eyebrow-stack--inverse w-full text-left" data-align="left">
            <div class="eyebrow-banner-wrapper text-left">
              <p
                class="eyebrow-banner eyebrow-banner--inverse"
                data-align="left"
                data-has-number={sectionNumber ? 'true' : undefined}
              >
                <span class="eyebrow-banner__label">{eyebrow}</span>
                {sectionNumber ? (
                  <span class="section-number-label text-white" aria-label={`Section ${sectionNumber}`}>
                    {sectionNumber}
                  </span>
                ) : null}
              </p>
            </div>
          </div>
        ) : null}
        {intro ? <p class="rich-intro rich-intro--inverse text-left">{intro}</p> : null}
      </div>
    )}
    <ol class="space-y-8">
      {steps.map(({ title, description }, index) => (
        <li class="flex gap-6">
          <div class="relative flex w-12 flex-col items-center">
            <span class="flex h-10 w-10 items-center justify-center rounded-full bg-white/10 text-xs font-semibold uppercase tracking-[0.16em] text-white border border-white/40 shadow-[0_0_25px_rgba(0,0,0,0.25)]">
              {String(index + 1).padStart(2, '0')}
            </span>
            {index < steps.length - 1 && (
              <span class="mt-3 w-px flex-1 bg-gradient-to-b from-white/40 via-white/15 to-transparent" aria-hidden="true"></span>
            )}
          </div>
          <article
            data-process-card
            class={cardClasses}
          >
            <h3 class="rich-subheading text-left text-white">{title}</h3>
            {description && <p class="mt-3 rich-intro rich-intro--inverse text-left text-white/85">{description}</p>}
          </article>
        </li>
      ))}
    </ol>
  </div>
  {shouldAnimate ? (
    <script>
      const roots = Array.from(document.querySelectorAll('[data-process-root]'));
      const supportMatchMedia = typeof window !== 'undefined' && typeof window.matchMedia === 'function';
      const prefersReducedMotion = supportMatchMedia
        ? window.matchMedia('(prefers-reduced-motion: reduce)').matches
        : false;
      const reveal = (el: Element | null) => {
        if (el instanceof HTMLElement) {
          el.dataset.visible = 'true';
        }
      };

      roots.forEach((root) => {
        const intro = root.querySelector('[data-process-intro]');
        const cards = Array.from(root.querySelectorAll('[data-process-card]'));
        const targets = [intro, ...cards].filter(Boolean);
        if (targets.length === 0) return;

        if (!prefersReducedMotion && 'IntersectionObserver' in window) {
          const observer = new IntersectionObserver(
            (entries, obs) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  const element = entry.target;
                  reveal(element);
                  obs.unobserve(element);
                }
              });
            },
            {
              rootMargin: '0px 0px -10% 0px',
              threshold: 0.1,
            },
          );

          targets.forEach((target) => observer.observe(target));
        } else {
          targets.forEach((target) => reveal(target));
        }
      });
    </script>
  ) : null}
</section>
