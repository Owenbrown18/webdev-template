---
interface Milestone {
  year?: string;
  title?: string;
  description?: string;
  image?: string;
}

interface Props {
  title: string;
  intro?: string;
  eyebrow?: string;
  milestones: Milestone[];
  backgroundClass?: string;
}

const {
  title,
  intro,
  eyebrow,
  milestones,
  backgroundClass,
}: Props = Astro.props as Props;

const sectionClasses = [
  backgroundClass,
  'section-shell',
  'relative',
  'isolate',
  backgroundClass ? 'overflow-hidden' : '',
]
  .filter(Boolean)
  .join(' ');
---
<section class={sectionClasses}>
  <div class="section-container space-y-12">
    <div class="section-intro max-w-3xl text-center">
      {eyebrow && <p class="section-eyebrow">{eyebrow}</p>}
      <h2 class="section-heading">{title}</h2>
      {intro && <p class="section-subtitle leading-7">{intro}</p>}
    </div>
    <div class="relative">
      <div class="pointer-events-none absolute left-3 top-6 hidden h-[calc(100%-3rem)] w-px bg-slate-200 lg:block" aria-hidden="true"></div>
      <div class="space-y-10">
        {milestones.map(({ year, title, description, image }, index) => (
          <div class="grid gap-6 lg:grid-cols-[minmax(0,320px)_minmax(0,1fr)] lg:items-start">
            <div class="relative pl-8 text-sm text-slate-600">
              <span class="absolute -left-[2.05rem] top-1 flex h-5 w-5 items-center justify-center rounded-full border-2 border-brand-primary bg-white shadow-[0_0_0_6px_rgba(var(--color-primary-rgb),0.08)]">
                <span class="h-2 w-2 rounded-full bg-brand-primary"></span>
              </span>
              <p class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">{year ?? `Step ${index + 1}`}</p>
              <p class="mt-2 text-base font-semibold text-slate-900">{title}</p>
            </div>
            <article
              data-timeline-card
              class="surface-card p-6 transition-shadow duration-200 hover:shadow-card-hover motion-safe:translate-y-6 motion-safe:opacity-0 motion-safe:transition-all motion-safe:duration-500 motion-safe:ease-out data-[visible=true]:motion-safe:translate-y-0 data-[visible=true]:motion-safe:opacity-100"
            >
              <div class="flex items-center gap-4 text-sm font-medium text-brand-primary">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-brand-primary/10 text-[0.75rem] font-semibold">
                  {year ?? index + 1}
                </span>
                <h3 class="text-lg font-semibold text-slate-900">{title}</h3>
              </div>
              <p class="mt-4 text-sm leading-6 text-slate-600">{description}</p>
              {image && (
                <div class="mt-6 overflow-hidden rounded-2xl border border-slate-200/80 bg-slate-100">
                  <img
                    src={image}
                    alt=""
                    class="h-40 w-full object-cover"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              )}
            </article>
          </div>
        ))}
      </div>
    </div>
  </div>
  <script>
    const cards = document.querySelectorAll('[data-timeline-card]');
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (!prefersReducedMotion && 'IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.dataset.visible = 'true';
              obs.unobserve(entry.target);
            }
          });
        },
        {
          rootMargin: '0px 0px -10% 0px',
          threshold: 0.1,
        },
      );

      cards.forEach((card) => observer.observe(card));
    } else {
      cards.forEach((card) => {
        card.dataset.visible = 'true';
      });
    }
  </script>
</section>
